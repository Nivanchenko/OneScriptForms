<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML><HEAD><TITLE>OneScriptFormsBlinking</TITLE>
<META content="text/html; charset=Windows-1252" http-equiv="Content-Type">
<LINK rel="stylesheet" type="text/css" href="mainstyle.css"></HEAD>
<BODY id=bodyID class=dtBODY>
<DIV id=nsbanner>
<DIV id=bannerrow1>
<TABLE class=bannerparthead cellSpacing=0>
  <TBODY>
  <TR id=hdr>
    <TD class=runninghead></TD>
    <TD class=product></TD></TR></TBODY></TABLE></DIV>
<DIV id=TitleRow>
<H1 class=dtH1>Устранение мигания формы или элементов</H1></DIV></DIV>
<DIV id=nstext>
<P>По рекомендации справки <A href="https://docs.microsoft.com/ru-ru/dotnet/api/system.windows.forms.control.setstyle?view=netframework-4.8" target="_blank">MSDN</A> устранить, или уменьшить мигание при перерисовке 
формы и элементов формы можно используя свойство <A href="OneScriptForms.Control.DoubleBuffered.html">ЭлементУправления.ДвойнаяБуферизация&nbsp;(Control.DoubleBuffered)</A>.</P>
<P>Способы устранения мигания рассмотрены также на <A href="https://codengineering.ru/q/how-to-stop-flickering-c-sharp-winforms-3516" target="_blank">этом</A> ресурсе.</P>
<P>Цитата из MSDN (с переводом): 
<BR>Самый простой способ использования двойной буферизации, установить флаг СтильЭлементаУправления <B>ОптимизированнаяДвойнаяБуферизация&nbsp;(OptimizedDoubleBuffer)</B> 
с помощью метода <B>ЭлементУправления.УстановитьСтиль&nbsp;(Control.SetStyle)</B>. Установка флага <B>ОптимизированнаяДвойнаяБуферизация&nbsp;(OptimizedDoubleBuffer)</B> 
для элемента управления перенаправляет все рисование для элемента управления через графический буфер по умолчанию, не требуя дополнительного кода. Этот флаг установлен 
в <B>Истина</B> по умолчанию.</P>
<P>Можно отказаться от события <B>ЭлементУправления.ПриПерерисовке&nbsp;(Control.Paint)</B>, заменив его своим методом, как в примере ниже.</P>
<P></P>
<H4 class=dtH4>Пример</H4>
<P><PRE class=code>
//вместо графики можно использовать фоновый рисунок на персонаже
//персонажи делаем объектами ПользовательскийЭлементУправления
//графику для объектов создаем только один раз
//прячем квадратные очертания ПользовательскийЭлементУправления используя одинаковые цвета
//по форме передвигаем ПользовательскийЭлементУправления
Перем Графика, Графика2, Икс, Икс2, Задержка, Персонаж1, Персонаж2, Форма1, РегуляторВверхВниз1, Перо1;

Процедура Фрейм()
	Персонаж1.Лево = Икс;
	Персонаж2.Лево = Икс2;
	Попытка // это для корректного закрытия формы
		Графика.Очистить(Форма1.ЦветФона);// убираем след на форме от Персонаж1
		Графика2.РисоватьЛинию(Перо1, 0, 38, 38, 0);
	Исключение
	КонецПопытки;
	Приостановить(Задержка);
КонецПроцедуры

Процедура РегуляторВверхВниз1_ЗначениеИзменено()
	Задержка = РегуляторВверхВниз1.Значение;
КонецПроцедуры

ПодключитьВнешнююКомпоненту("C:\444\111\OneScriptForms\OneScriptForms\bin\Debug\OneScriptForms.dll");
Ф = Новый ФормыДляОдноСкрипта();
Форма1 = Ф.Форма();
Форма1.Ширина = 1210;
Форма1.Высота = 250;
Форма1.Отображать = Истина;
Форма1.Показать();
Форма1.Активизировать();
Графика = Форма1.СоздатьГрафику();

Перо1 = Ф.Перо(Ф.Цвет().БледноЗеленый, 18);
Икс = 1;
Икс2 = Окр(Икс / 15);
Задержка = 2;

Надпись1 = Форма1.ЭлементыУправления.Добавить(Ф.Надпись());
Надпись1.Текст = "Задержка (миллисекунд)";
Надпись1.Ширина = 170;
Надпись1.Лево = 20;
Надпись1.Верх = 160;

РегуляторВверхВниз1 = Форма1.ЭлементыУправления.Добавить(Ф.РегуляторВверхВниз());
РегуляторВверхВниз1.Правее(Надпись1, 10);
РегуляторВверхВниз1.Верх = Надпись1.Верх;
РегуляторВверхВниз1.Значение = Задержка;
РегуляторВверхВниз1.Максимум = 2000;
РегуляторВверхВниз1.ЗначениеИзменено = "РегуляторВверхВниз1_ЗначениеИзменено()";

Персонаж1 = Форма1.ЭлементыУправления.Добавить(Ф.ПользовательскийЭлементУправления());
Персонаж1.Верх = 20;
Персонаж1.Ширина = 100;
Персонаж1.Высота = 100;
Персонаж1.ЦветФона = Ф.Цвет().Синий;

Персонаж2 = Персонаж1.ЭлементыУправления.Добавить(Ф.ПользовательскийЭлементУправления());
Персонаж2.Верх = 20;
Персонаж2.Ширина = 38;
Персонаж2.Высота = 38;
Персонаж2.ЦветФона = Ф.Цвет().Синий;//фон одинаков с фоном Персонаж1, чтобы нам была видна только графика Персонаж2, а не он сам квадратный.
Графика2 = Персонаж2.СоздатьГрафику();//Графика2 в дальнейшем не пересоздается

А = 1;
Пока Истина Цикл
	А = А + 1;
	Если А >= 1100 Тогда
		А = -1100;
	КонецЕсли;
	Икс = Ф.Математика().ККорень(А*А);
	Икс2 = Окр(Икс / 18);//делитель просто подобрал

	// обеспечим корректное закрытие формы
	Если Не(Форма1.Отображать) Тогда
		ЗавершитьРаботу(10);
	Иначе
		Фрейм();                
	КонецЕсли;

	// обеспечим отклик приложения на действия пользователя
	Если Ф.ЧислоСообщений() > 0 Тогда
		Выполнить(Ф.ПолучитьСобытие());
	КонецЕсли;
	Ф.ПередатьУправление();
КонецЦикла;

// этот цикл сейчас не нужен, событие получаем внутри бесконечного цикла
// Пока Ф.Продолжать Цикл
	// Выполнить(Ф.ПолучитьСобытие());
// КонецЦикла;
</PRE>
<P></P>
<P>Лучшие результаты дает такой приём. Вместо рисования графики на объекте рисуем на картинке в памяти, а затем присваиваем этот рисунок объекту. В примере ниже 
на форме расположены два объекта ПолеКартинки. Левое поле картинки использует этот приём, правое использует обычное рисование графики на объекте. На правом 
поле картинки заметно сильное мигание.</P>
<P><PRE class=code>
Перем Ф, Форма1, РегуляторВверхВниз1, СплошнаяКисть1, СплошнаяКисть2, Флажок1, Флажок2;
Перем ИзображениеВПамяти, Графика1, Графика2, Перо1, ПолеКартинки1, ПолеКартинки2, Икс, Икс2, Картинка1, А; 

Процедура ПолеКартинки2_ПриПерерисовке()
	Графика2 = ПолеКартинки2.СоздатьГрафику();
	Графика2.Очистить(Ф.Цвет().Зеленый);
	Графика2.ЗаполнитьПрямоугольник(СплошнаяКисть2, 0, 0, ПолеКартинки2.Ширина, ПолеКартинки2.Высота);
	Графика2.Освободить();
КонецПроцедуры

Процедура ПолеКартинки1_ПриПерерисовке()
	Графика1 = ПолеКартинки1.СоздатьГрафику().ИзИзображения(Картинка1);
	Графика1.Очистить(Ф.Цвет().Синий);
	Графика1.ЗаполнитьПрямоугольник(СплошнаяКисть1, 0, 0, ПолеКартинки1.Ширина, ПолеКартинки1.Высота);
	ПолеКартинки1.Изображение = Картинка1;
	Графика1.Освободить();
КонецПроцедуры

Процедура Таймер1_ПриСрабатыванииТаймера()
	ПолеКартинки1.Актуализировать();
	ПолеКартинки2.Актуализировать();
КонецПроцедуры

ПодключитьВнешнююКомпоненту("C:\444\111\OneScriptForms\OneScriptForms\bin\Debug\OneScriptForms.dll");
Ф = Новый ФормыДляОдноСкрипта();
Форма1 = Ф.Форма();
Форма1.Ширина = 1210;
Форма1.Высота = 250;
Форма1.Отображать = Истина;
Форма1.Показать();
Форма1.Активизировать();

Таймер1 = Ф.Таймер();
Таймер1.Интервал = 10;
Таймер1.ПриСрабатыванииТаймера = "Таймер1_ПриСрабатыванииТаймера()";
Таймер1.Начать();

ПолеКартинки1 = Форма1.ЭлементыУправления.Добавить(Ф.ПолеКартинки());
ПолеКартинки1.Стыковка = Ф.СтильСтыковки.Лево;
ПолеКартинки1.Ширина = Форма1.Ширина / 2;
ПолеКартинки1.Высота = Форма1.Высота;
ПолеКартинки1.ПриПерерисовке = "ПолеКартинки1_ПриПерерисовке()";

ПолеКартинки2 = Форма1.ЭлементыУправления.Добавить(Ф.ПолеКартинки());
ПолеКартинки2.Стыковка = Ф.СтильСтыковки.Заполнение;
ПолеКартинки2.ПриПерерисовке = "ПолеКартинки2_ПриПерерисовке()";

СплошнаяКисть1 = Ф.СплошнаяКисть(Ф.Цвет("Синий"));
СплошнаяКисть2 = Ф.СплошнаяКисть(Ф.Цвет("Зеленый"));

// сделаем картинку одноцветной
// картинку нельзя пересоздавать при перерисовке, оперативка быстро исчерпается
// но мы можем сделать её по размеру заведомо большой, во весь экран
// тогда даже при разворачивании формы во весь экран, картинка не будет обрезаной
Картинка1 = Ф.Картинка(, Ф.Размер(1000, 1000));

Пока Ф.Продолжать Цикл
      Выполнить(Ф.ПолучитьСобытие());
КонецЦикла;
</PRE>
<H4 class=dtH4>Смотрите также</H4>
<P><A href="OneScriptForms.html">Библиотека&nbsp;OneScriptForms</A></P></DIV>
</BODY></HTML>
